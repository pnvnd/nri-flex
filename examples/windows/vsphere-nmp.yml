# Monitor a single file or multiple files in a directory
# SELECT ArrayPriority, Device, DeviceDisplayName, GroupState, Path, PathSelectionPolicyPathConfig, RuntimeName, StorageArrayTypePathConfig FROM VSphereNMPSample LIMIT MAX SINCE 5 MINUTES AGO
# Example for NRQL Alert: SELECT * FROM VSphereNMPSample
integrations:
  - name: nri-flex
    interval: 300s # This is the Infrastructure agent polling interval for this Flex configuration, set to one poll every 300 seconds
    config:
      name: VSphereNMPSample
      apis:
        - event_type: VSphereNMPSample
          shell: powershell
          timeout: 300000
          commands:
            - run: >
                Import-Module VMware.VimAutomation.Core;
                
                $vCenterServer="127.0.0.1";
                $vCenterPort="9090";
                $vCenterUser="user";
                $vCenterPassword="pass";

                Connect-VIServer -Server $vCenterServer -Port $vCenterPort -User $vCenterUser -Password $vCenterPassword -Force | Out-Null;
                
                $paths=@();
                
                # Loop through each VM host
                Get-VMHost | ForEach-Object {
                  # Get the name of the current VM host
                  $vmHostName = $_.Name
                  
                  # Get the storage paths for the current VM host
                  $storagePaths = (Get-EsxCli -VMHost $_).Storage.Nmp.Path.List()
                  
                  # Loop through each storage path
                  foreach ($path in $storagePaths) {
                    # Add the path information to the array
                    $paths += @{
                      VMServerName = $vSphereServerName
                      VMHostName = $vmHostName
                      ArrayPriority = $path.ArrayPriority
                      Device = $path.Device
                      DeviceDisplayName = $path.DeviceDisplayName
                      GroupState = $path.GroupState
                      Path = $path.Path
                      PathSelectionPolicyPathConfig = $path.PathSelectionPolicyPathConfig
                      RuntimeName = $path.RuntimeName
                      StorageArrayTypePathConfig = $path.StorageArrayTypePathConfig
                    }
                  }
                };
                
                $paths | ConvertTo-Json;
